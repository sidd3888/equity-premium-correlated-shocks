\section{Model}\label{model}

\subsection{The basic problem}

I start by examining the basic consumption-saving problem. The individual maximizes their discounted lifetime utility from the consumption stream $\bc{C_{t}}_{t=0}^{T}$, where $T = \infty$ in the infinite-horizon model
\begin{equation}\label{eq:prb}
   \max_{\bc{C_t}_{t=0}^{T}}\E_{0}\sum_{t=0}^{T}\b^t u(C_t)
\end{equation}
subject to the period-wise constraints
\begin{align*}
    C_{t} + A_{t+1} &= W_{t} + Y_{t}
\end{align*}
where $A_{t+1}$ is the total level of investment in assets incoming in period $t+1$, $W_{t}$ the total monetary wealth at the beginning of the period, and $Y_{t}$ is the current-period income. Income can be modelled as centered around an ``expected" permanent income
\begin{equation}\label{eq:inc}
    Y_t = \z_t P_t
\end{equation}
where $\z_t$ is a transitory mean-one shock. Permanent income, $P_t$, itself grows according to
\begin{equation}\label{eq:perm_inc}
    P_t = \G_t P_{t-1} \eta_t
\end{equation}
where $\G_t$ is the predictable component of the growth of permanent income, and $\eta_t$ is a mean-one shock. Further, individuals can also invest, in a perfectly divisible manner, between a risk-free and a risky (equity) asset. If the consumer chooses to hold $\k_{t+1}$ share of the savings in the risky asset in period $t$ (that is, their portfolio at the start of period $t+1$ contains $\k_{t+1}$ share of the risky asset), wealth in period $t+1$ is determined by
\begin{align}
    W_{t+1} &= \overbrace{\bp{\Rfix + \k_{t+1}(\Rfree_{t+1} - \Rfix)}}^{\Rc_{t+1}}A_{t+1} \label{eq:wealth}\\
    \Rfree_{t+1} &= \Rfree \nu_{t+1} \label{eq:return}
\end{align}
where $\Rfree_{t+1}$ is the return on the investments made in the risky asset in period $t$, $\nu_{t+1}$ is a mean-one shock, and $\Rc_{t+1}$ is the effective rate of return on assets stemming from the portfolio optimization decision $\k_{t+1}$. The choice of $\k_{t+1}$ is restricted to the interval $\bs{0,\,1}$, thus precluding debt-financed equity positions. I impose an artificial borrowing constraint on the consumer that limits their borrowing as a proportion of their permanent income,
\[
A_{t+1} \geq \underline{a}P_{t} \tag{$\underline{a} \leq 0$}
\]
It is reasonable to model borrowing limits as dependent on permanent income, which is something that is observed practically. In the context of this problem, it also aids in preserving its homotheticity (see below). I set $\underline{a} = 0$ to focus purely on how savings are allocated between the two assets. We can then use equation (\ref{eq:wealth}) rewrite the period budget constraint as
\[
W_{t+1} = \Rc_{t+1}(W_{t} + Y_{t} - C_{t})
\]
Allowing $M_t = W_t + Y_t$ to denote the total current level of monetary resources
\[
M_{t+1} = \Rc_{t+1}(M_t - C_t) + Y_{t+1}
\]
Writing the problem from equation (\ref{eq:prb}) in Bellman form with the added assumption that the period utility from consumption assumes a CRRA form,
\begin{equation}
    % V(M_t,\,P_t) = \max_{\bc{C_t,\,\k_t}}\frac{C_t^{1-\rho}}{1 - \rho} + \b \E_t\bs{V(\Rc_{t+1}(M_t - C_t) + Y_{t+1},\,P_{t+1})}\\
    V_t(M_t,\,P_t) = \max_{\bc{C_t,\,\k_{t+1}}}\frac{C_{t}^{1-\rho}}{1 - \rho} + \b \E_t\bs{V_{t+1}(\Rc_{t+1}(M_t - C_{t}) + Y_{t+1},\,P_{t+1})}
\end{equation}
Normalize all period $t$ variables by the permanent income $P_t$ (since $A_t$ is determined in period $t-1$, it is normalized by $P_{t-1}$), and denote these new variables in lowercase (i.e. $c_t = C_t / P_t$). Letting $\Gc_{t+1} = \G_{t+1}\eta_{t+1}$,
\begin{align*}
    m_{t+1} = \frac{\Rc_{t+1}}{\Gc_{t+1}}(m_t - c_t) + \z_{t+1}
\end{align*}
The Bellman formulation then becomes
\begin{equation}\label{eq:bellman}
    % v(m_t) = \max_{c_t,\,\k_t}\frac{c_t^{1-\rho}}{1-\rho} + \beta \E_{t}\bs{\Gc_{t+1}^{1-\rho}v\bp{\frac{\Rc_{t+1}}{\Gc_{t+1}}(m_t - c_t) + \z_{t+1}}}\\
    v_{t}(m_t) = \max_{c_{t},\,\k_{t+1}}\frac{c^{1-\rho}}{1-\rho} + \beta \E\bs{(\Gc_{t+1})^{1-\rho}v_{t+1}\bp{\frac{\Rc_{t+1}}{\Gc_{t+1}}(m_t - c_t) + \z_{t+1}}}
\end{equation}
and the consumption Euler equation is then given by\footnote{Use the following steps to show that under optimality, $u'(c_t) = v'(m_t)$
\begin{align*}
    u'(c_t) &= \b \E\bs{\Gc_{t+1}^{-\rho}\Rc_{t+1}v'(m_{t+1})}\\
    v'(m_t) &= v_{m}(m_t,\,c_t(m_t)) + \pd{c_t}{m_t}v_{c}(m_t,\,c_t(m_t))\\
    &= v_{m}(m_t,\,c_t(m_t)) + \pd{c_t}{m_t}\bs{u'(c_t) - \b \E\bs{\Gc_{t+1}^{-\rho}\Rc_{t+1}v'(m_{t+1}}}\\
    &= v_{m}(m_t,\,c_t(m_t))\\
    &= \b \E\bs{\Gc_{t+1}^{-\rho}\Rc_{t+1}v'(m_{t+1})}
\end{align*}
Then using the same conditions under optimality for period $t+1$, replace $v'(m_{t+1})$ with $u'(c_{t+1})$.
}
\begin{equation}\label{eq:euler}
    c_t^{-\rho} = \b \E_{t}\bs{\Rc_{t+1}(\Gc_{t+1}c_{t+1})^{-\rho}}
\end{equation}
The optimality condition for the portfolio share, $\k_{t+1}$ is slightly trickier, given that it is bounded by $\bs{0,\,1}$. Finally, note that portfolio share is irrelevant when $a_{t+1} = 0$, which means that we can only pin it down for when $a_{t+1} \neq 0$. In that case, a choice of $\k_{t+1}$ is optimal if
\begin{equation}\label{eq:excess_return}
    \begin{cases}
        \E_{t}\bs{(\Rfree_{t+1} - \Rfix)(\Gc_{t+1}c_{t+1})^{-\rho}} = 0 & \k_{t+1} \in \bp{0,\,1}\\
        \E_{t}\bs{(\Rfree_{t+1} - \Rfix)(\Gc_{t+1}c_{t+1})^{-\rho}} \geq 0 & \k_{t+1} = 1\\
        \E_{t}\bs{(\Rfree_{t+1} - \Rfix)(\Gc_{t+1}c_{t+1})^{-\rho}} \leq 0 & \k_{t+1} = 0
    \end{cases}
\end{equation}
% while the first order condition for $\k_{t+1}$ is given by
% % \begin{align*}
% %     \b \E_{t} \bs{\Gc_{t+1}^{-\rho}(\Rfree_{t+1} - \Rfix)(m_t - c_t)v'(m_{t+1})} &= 0\\
% %     \E_{t}\bs{\Gc_{t+1}^{-\rho}(\Rfree_{t+1} - \Rfix)(m_t - c_t)u'(c_{t+1})} &= 0
% % \end{align*}
% \begin{equation}\label{eq:excess_return}
%     a_{t+1}\E_{t}\bs{\bp{\Rfree_{t+1} - \Rfix}(\Gc_{t+1}c_{t+1})^{-\rho}} = 0
% \end{equation}
% When optimal $a_{t+1} \neq 0$, then
% % \footnote{It is sufficient to show that
% % \[
% % m_{t}^{-\rho} < \b \E_{t}\bs{\Rc_{t+1}(G_{t+1}\z_{t+1})^{-\rho}}
% % \]
% % }
% \[
% \E_{t}\bs{(\Rfree_{t+1} - \Rfix)(\Gc_{t+1}c_{t+1})^{-\rho}} = 0
% \]
Now see that whenever the optimal portfolio decision is to hold a mixture of both the safe and the risky asset, the consumption Euler equation can be reduced to
\begin{align*}
    c_{t}^{-\rho} &= \b \E_{t}\bs{(\Rfix + \k_{t+1}(\Rfree_{t+1} - \Rfix))(\Gc_{t+1}c_{t+1})^{-\rho}}\\
    &= \b \bs{\E_{t}\bs{\Rfix(\Gc_{t+1}c_{t+1})^{-\rho}} + \k_{t+1}\E_{t}\bs{(\Rfree_{t+1} - \Rfix)(\Gc_{t+1}c_{t+1})^{-\rho}}}\\
    &= \b\Rfix\G_{t+1}^{-\rho}\E_{t}\bs{(\eta_{t+1}c_{t+1})^{-\rho}} \tag{from (\ref{eq:excess_return})}
\end{align*}
% Note that $\E_{t}\bs{(\eta_{t+1}c_{t+1})^{-\rho}} > (\E_{t}c_{t+1})^{-\rho}$, so we require $\limsup_{n\to \infty}\b\Rfix\G_{t+1}^{-\rho} < 1$ as the impatience condition for the existence of a steady-state normalized consumption.
I have hitherto remained silent on the exact distribution followed by the shocks to income and wealth. First, I assume that shocks are independent across time periods. Then, I model the shocks to be jointly lognormally distributed. In particular,
% \begin{align*}
%     \log \z_t \sim \Nc(-\s_{\z}^2 / 2,\,\s_{\z}^2)
% \end{align*}
% while
\begin{align*}
    \log (\eta_t,\,\nu_t,\,\z_t) \sim \Nc(\mu,\,\S)
\end{align*}
where
\begin{align*}
    \S &= \begin{bmatrix}
        \s_{\eta}^2 & \o_{\eta,\,\nu} & \o_{\eta,\,\z}\\
        \o_{\nu,\,\eta} & \s_{\nu}^2 & \o_{\eta,\,\nu}\\
        \o_{\z,\,\eta} & \o_{\nu,\,\eta} & \s_{\z}^2
    \end{bmatrix}\\
    \mu &= \begin{bmatrix}
        -\s_{\eta}^2 / 2\\
        -\s_{\nu}^2 / 2\\
        -\s_{\z}^2 / 2
    \end{bmatrix}
\end{align*}
The marginal distributions of each of the shocks ensure that $\E_t[\eta] = \E_t[\nu] = \E_t[\z] = 1$. Meanwhile, $\o_{x,\,y}$ captures the covariance of any two variables $x$ and $y$ among the three.

\subsection{Solving the model}

\subsubsection{Discretizing the joint distribution}\label{discretization}

The first part of solving the model is to address the problem of efficiently computing expectations of the marginal utilities of consumption decisions in future periods. Under the current formulation, the shocks to income and returns are drawn independently in each time period, which means that it is enough to discretize these shocks using their single-period distribution. I use an equiprobable approximation of a truncated version (at 3 standard deviations of the underlying standard normal) of these lognormal variables.\footnote{The code for this algorithm is available as part of a \href{https://github.com/econ-ark/HARK/pull/1412}{contribution} I made to the \href{https://github.com/econ-ark/HARK}{HARK} toolkit.}

Here are the steps involved in discretizing the distribution:
\begin{enumerate}
    \item Choose a suitable truncation of the distribution in each dimension by choosing an interval $\bs{p_{min},\,p_{max}} \subseteq \bs{0,\,1}$
    \item Divide the interval given by $\bs{\Phi^{-1}(p_{min}),\,\Phi^{-1}(p_{max})}$ into $n$ intervals of $\frac{p_{max} - p_{min}}{n}$ probability each, $I = \bc{\bs{\Phi^{-1}\left(\frac{(i - 1)p_{max} + (n - i + 1)p_{min}}{n}\right),\,\Phi^{-1}\left(\frac{ip_{max} + (n - i)p_{min}}{n}\right)}}_{i=1}^{n}$
    \item Decompose the covariance matrix $\S$ using the Cholesky decomposition and obtain a matrix $L$ such that $LL^T = \S$
    \item Then construct the random variables $Y = \mu + LZ$, where $Z \sim \Nc(0,\,I)$, to get $Y \sim \Nc(\mu,\,\Sigma)$
    \item Construct the set $I^3$ and , and compute the conditional expectation of the vector of shocks $X = \exp(Y)$ in each set of $I^3$, yielding the set of equiprobable atoms $S = \bc{\bp{\eta,\,\nu,\,\z}_{j}}_{j=1}^{n^3}$
\end{enumerate}

Computing expectations of functions of these shocks can now be reduced to the following approximation
\[
\E\bs{g(\eta,\,\nu,\,\z)} \approx n^{-3}\sum_{j=1}^{n^3}g(\eta_j,\,\nu_j,\,\z_j)
\]

\subsubsection{Computing optimal decisions}

I solve the model using a sequential application of the endogenous grid method \citep{Carroll2006}, dividing a period into two subperiods, the first stage involving a consumption decision ($c$), and the second involving the portfolio optimization problem ($\k$). This description largely pertains to the finite-horizon version, though the infinite-horizon solution merely replaces periods with a sequence of guesses.

Construct a grid of assets $\Ac = \bs{\underline{a} = a_1 < a_2 < ... < a_k = \overline{a}}$. To solve the problem pertaining to any period $t$, observe from equation (\ref{eq:excess_return}) that whenever $a_i \neq 0$, the optimal share of risky assets is given by the choice of $\hat{\k}_{t+1}(a_i) \in [0,\,1]$ such that
\begin{equation}\label{eq:kappa}
n^{-3}\G_{t+1}^{-\rho}\sum_{j=1}^{n^3}(\Rfree\nu_i - \Rfix)(\eta_{j}c_{t+1}(m_{ij}))^{-\rho} = 0
\end{equation}
where
\[
m_{ij} = \frac{\Rfix + \hat{\k}_{t+1}(a_i)(\Rfree\nu_j - \Rfix)}{\G_{t+1}\eta_{j}}a_i + \z_j
\]
The problem then becomes a root-finding operation pertaining to a function of $\hat{\k}$, which, given a policy function $c_{t+1}$, yields an optimal level of $\hat{\k}$ for each $a_i$. Denote this pair as $(a,\,\hat{\k})_{i}$, and the resulting effective return $\Rfix + \hat{\k}_{i}(\Rfree\nu_{j} - \Rfix)$ for each value of the shocks as $\Rc_{ij}$.

For each \textit{end-of-period} outcome $(a,\,\hat{\k})_i$, given $c_{t+1}$, we can use the consumption Euler equation to get
\[
[\hat{c}_t(a_i,\,\hat{\k}_i)]^{-\rho} = \b\G_{t+1}^{-\rho} n^{-3}\sum_{j=1}^{n^3}\Rc_{ij}(\eta_{j}c_{t+1}(m_{ij}))^{-\rho}
\]
where $\hat{c}$ denotes that this yields a consumed function of the assets and portfolio share.
This function is then given by
\[
\hat{c}_{t}(a_i,\,\hat{\k}_i) = \bs{\b\G_{t+1}^{-\rho}n^{-3}\sum_{j=1}^{n^3}\Rc_{ij}(\eta_{j}c_{t+1}(m_{ij}))^{-\rho}}^{-\frac{1}{\rho}}
\]
Now we have a vector of $\hat{c}_i$ corresponding to each $(a,\,\hat{\k})_i$. Since $m_{t} = c_{t} + a_{t+1}$, we can construct the grid $\Mc$ with each $m_i \in \Mc$ given by $m_i = \hat{c}_i + a_i$, where $\hat{c}_{i} = \hat{c}_{t}(a_i,\,\hat{\k}_i)$. We can now rewrite $c_t(m_i) = \hat{c}_t(a_i,\,\hat{\k}_i)$ and $\k_{t+1}(m_i) = \hat{\k}_{t+1}(a_i)$, and interpolate to get the policy functions $(c_{t}(m),\,\k_{t+1}(m)) = g_{t}(m)$ for period $t$.\footnote{While I use linear interpolation by default, cubic-spline interpolation yields similar results for the consumption function. However, due to drastic directional changes in the optimal portfolio share, spline interpolation sometimes suggests a portfolio share outside the interval $[0,\,1]$.} In the finite-horizon case, the model can be solved using $c_{T}(m) = m$ as the initial policy function and iterating backwards till period 0. For the infinite-horizon case, I use a guess $c_{0}(m)$ to obtain a sequence of guesses $\bc{c_{k}(m),\,\k_{k}(m)}_{k=0}^{K}$ that converge to the true policy functions $c(m)$ and $\k(m)$. Since my focus is not on life-cycle applications, I solve each model with a constant permanent growth factor $\G$.

% Finally, we can use $c_{T}(m) = m$ as a starting point and recursively obtain the estimated policy functions. To simplify the computation, I solve the model with a time-invariant expected permanent income growth rate, though this assumption is in no way necessary.

% \textsc{Infinite-Horizon}

% Since it is impossible to store an infinite sequence of values for the predictable growth factors $\G_{t}$, I simplify the infinite-horizon problem by assuming that $\G_{t} = \G$ for all periods $t$, i.e. $\bc{\G_{t}}_{t=0}^{\infty}$ is a constant sequence. Then the Bellman equation can be simplified to
% \[
% v(m) = \max_{c,\,\k'}\frac{c^{1-\rho}}{1-\rho} + \beta\G^{1-\rho} \E\bs{(\eta')^{1-\rho}v\bp{\frac{\Rfix + \k'(\Rfree' - \Rfix)}{\G\eta'}(m - c) + \z'}}
% \]
% We can use the same process as in the finite-horizon case, where I use the first-order conditions to find the policy functions. The only difference, now, is that instead of using $c_{t+1}$ to find $\k_{t+1}$ and $c_{t}$, I now use an initial guess about the time-invariant $c$, say $c_{0}$, to compute $c_{1}$ and $\k_1$. I use this newly computed $c_1$ to obtain $c_2$ and $\k_2$. This process continues, till the policy functions converge to an approximation of $c(m)$ and $\k(m)$.